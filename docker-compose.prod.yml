# Production Docker Compose
# Deploys all services with production-ready configuration

services:
  # Jaeger - Distributed Tracing Backend
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: pathfinder-jaeger
    ports:
      - "16686:16686"   # Jaeger UI
      - "4317:4317"     # OTLP gRPC
      - "4318:4318"     # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - COLLECTOR_OTLP_HTTP_CORS_ALLOWED_ORIGINS=http://localhost
      - COLLECTOR_OTLP_HTTP_CORS_ALLOWED_HEADERS=content-type
    networks:
      - pathfinder-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:16686"]
      interval: 30s
      timeout: 5s
      retries: 3

  # .NET API Backend
  api:
    build:
      context: ./PathfinderApi
      dockerfile: Dockerfile
    container_name: pathfinder-api
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - OpenTelemetry__ServiceName=pathfinder-api
      - OpenTelemetry__OtlpEndpoint=http://jaeger:4317
    depends_on:
      jaeger:
        condition: service_healthy
    networks:
      - pathfinder-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Angular UI Frontend
  ui:
    build:
      context: ./pathfinder-ui
      dockerfile: Dockerfile
    container_name: pathfinder-ui
    ports:
      - "80:80"
    environment:
      - API_URL=http://api:8080
      - JAEGER_URL=http://jaeger:4318
    depends_on:
      api:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    networks:
      - pathfinder-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  pathfinder-network:
    driver: bridge
